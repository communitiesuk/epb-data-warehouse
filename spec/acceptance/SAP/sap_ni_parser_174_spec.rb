RSpec.describe "the parser and the SAP configuration (for Northern Ireland)" do
  let(:use_case) { UseCase::ParseXmlCertificate.new }

  context "when loading XML from SAP (NI)" do
    let(:sap) do
      Samples.xml "SAP-Schema-NI-17.4"
    end

    it "parses the document into the expected format" do
      expectation = { "sap_version" => 9.9,
                      "sap_data_version" => 9.81,
                      "bedf_revision_number" => 412,
                      "calculation_software_name" => "Elmhurst Energy Systems Design SAP 2009",
                      "calculation_software_version" => "1.18r04",
                      "inspection_date" => "2017-05-12",
                      "report_type" => 3,
                      "completion_date" => "2017-05-12",
                      "registration_date" => "2017-05-12",
                      "status" => "entered",
                      "language_code" => 1,
                      "restricted_access" => 0,
                      "transaction_type" => 6,
                      "tenure" => "ND",
                      "seller_commission_report" => "Y",
                      "property_type" => 0,
                      "scheme_assessor_id" => "EXM/000002",
                      "address_line_1" => "12,Addess Lane",
                      "post_town" => "Town",
                      "postcode" => "BT1 1AA",
                      "uprn" => 9,
                      "region_code" => 10,
                      "country_code" => "NIR",
                      "assessment_date" => "2017-05-12",
                      "walls" =>
                       [{ "description" => "²K",
                          "energy_efficiency_rating" => 5,
                          "environmental_efficiency_rating" => 5 }],
                      "roofs" =>
                       [{ "description" => "²K",
                          "energy_efficiency_rating" => 4,
                          "environmental_efficiency_rating" => 4 }],
                      "floors" =>
                       [{ "description" => "²K",
                          "energy_efficiency_rating" => 4,
                          "environmental_efficiency_rating" => 4 }],
                      "windows" =>
                       { "description" => "High performance glazing",
                         "energy_efficiency_rating" => 5,
                         "environmental_efficiency_rating" => 5 },
                      "main_heating" =>
                       [{ "description" => "Boiler and radiators, mains gas",
                          "energy_efficiency_rating" => 4,
                          "environmental_efficiency_rating" => 4 }],
                      "main_heating_controls" =>
                       [{ "description" => "Programmer, room thermostat and TRVs",
                          "energy_efficiency_rating" => 4,
                          "environmental_efficiency_rating" => 4 }],
                      "secondary_heating" =>
                       { "description" => "None",
                         "energy_efficiency_rating" => 0,
                         "environmental_efficiency_rating" => 0 },
                      "hot_water" =>
                       { "description" => "From main system",
                         "energy_efficiency_rating" => 4,
                         "environmental_efficiency_rating" => 4 },
                      "lighting" =>
                       { "description" => "Low energy lighting in 57% of fixed outlets",
                         "energy_efficiency_rating" => 4,
                         "environmental_efficiency_rating" => 4 },
                      "air_tightness" =>
                       { "description" => "³/h.m² (as tested)",
                         "energy_efficiency_rating" => 4,
                         "environmental_efficiency_rating" => 4 },
                      "has_fixed_air_conditioning" => "false",
                      "has_hot_water_cylinder" => "false",
                      "has_heated_separate_conservatory" => "false",
                      "dwelling_type" => "End-terrace house",
                      "total_floor_area" => 97,
                      "energy_rating_average" => 60,
                      "energy_rating_typical_newbuild" => 81,
                      "energy_rating_current" => 81,
                      "energy_rating_potential" => 82,
                      "environmental_impact_current" => 83,
                      "environmental_impact_potential" => 84,
                      "energy_consumption_current" => 98,
                      "energy_consumption_potential" => 94,
                      "co2_emissions_current" => 1.8,
                      "co2_emissions_potential" => 1.7,
                      "co2_emissions_current_per_floor_area" => 19,
                      "lighting_cost_current" => 97,
                      "lighting_cost_potential" => 68,
                      "heating_cost_current" => 303,
                      "heating_cost_potential" => 307,
                      "hot_water_cost_current" => 110,
                      "hot_water_cost_potential" => 110,
                      "suggested_improvements" =>
                       [{ "sequence" => 1,
                          "improvement_category" => 1,
                          "improvement_type" => "E",
                          "improvement_details" => { "improvement_number" => 35 },
                          "typical_saving" => 26,
                          "indicative_cost" => "£45",
                          "energy_performance_rating" => 82,
                          "environmental_impact_rating" => 84 },
                        { "sequence" => 2,
                          "improvement_category" => 3,
                          "improvement_type" => "N",
                          "improvement_details" => { "improvement_number" => 19 },
                          "typical_saving" => 32,
                          "indicative_cost" => "£4,000 - £6,000",
                          "energy_performance_rating" => 83,
                          "environmental_impact_rating" => 85 },
                        { "sequence" => 3,
                          "improvement_category" => 3,
                          "improvement_type" => "U",
                          "improvement_details" => { "improvement_number" => 34 },
                          "typical_saving" => 281,
                          "indicative_cost" => "£9,000 - £14,000",
                          "energy_performance_rating" => 92,
                          "environmental_impact_rating" => 94 }],
                      "data_type" => 2,
                      "schema_version" => "LIG-17.3",
                      "built_form" => 3,
                      "living_area" => 15.98,
                      "orientation" => 5,
                      "conservatory_type" => 1,
                      "is_in_smoke_control_area" => "unknown",
                      "sap_opening_types" =>
                       [{ "name" => "Front",
                          "data_source" => 2,
                          "type" => 1,
                          "glazing_type" => 1,
                          "u_value" => 3 },
                        { "name" => "Front",
                          "data_source" => 2,
                          "type" => 4,
                          "glazing_type" => 5,
                          "solar_transmittance" => 0.72,
                          "frame_factor" => 0.7,
                          "u_value" => 1.5 },
                        { "name" => "Gable - W",
                          "data_source" => 2,
                          "type" => 4,
                          "glazing_type" => 5,
                          "solar_transmittance" => 0.72,
                          "frame_factor" => 0.7,
                          "u_value" => 1.5 },
                        { "name" => "Gable - E",
                          "data_source" => 2,
                          "type" => 4,
                          "glazing_type" => 5,
                          "solar_transmittance" => 0.72,
                          "frame_factor" => 0.7,
                          "u_value" => 1.5 },
                        { "name" => "Rear",
                          "data_source" => 2,
                          "type" => 4,
                          "glazing_type" => 5,
                          "solar_transmittance" => 0.72,
                          "frame_factor" => 0.7,
                          "u_value" => 1.5 }],
                      "sap_building_parts" =>
                       [{ "building_part_number" => 1,
                          "identifier" => "Main Dwelling",
                          "construction_year" => 2014,
                          "overshading" => 2,
                          "sap_openings" =>
                           [{ "name" => "Front",
                              "type" => "Front",
                              "location" => "Walls (1)",
                              "orientation" => 0,
                              "width" => 1.91,
                              "height" => 1 },
                            { "name" => "Front",
                              "type" => "Front",
                              "location" => "Walls (1)",
                              "orientation" => 5,
                              "width" => 7.07,
                              "height" => 1 },
                            { "name" => "Gable - W",
                              "type" => "Gable - W",
                              "location" => "Walls (1)",
                              "orientation" => 7,
                              "width" => 0.77,
                              "height" => 1 },
                            { "name" => "Gable - E",
                              "type" => "Gable - E",
                              "location" => "Walls (1)",
                              "orientation" => 3,
                              "width" => 7.16,
                              "height" => 1 },
                            { "name" => "Rear",
                              "type" => "Rear",
                              "location" => "Walls (1)",
                              "orientation" => 1,
                              "width" => 8.31,
                              "height" => 1 }],
                          "sap_floor_dimensions" =>
                           [{ "storey" => 0,
                              "floor_type" => 2,
                              "total_floor_area" => 54.69,
                              "storey_height" => 2.55,
                              "heat_loss_area" => 54.69,
                              "u_value" => 0.21 },
                            { "storey" => 1,
                              "floor_type" => 3,
                              "total_floor_area" => 41.86,
                              "storey_height" => 2.7,
                              "heat_loss_area" => 0,
                              "u_value" => 0 }],
                          "sap_roofs" =>
                           [{ "name" => "Roof (1)",
                              "roof_type" => 2,
                              "total_roof_area" => 44.42,
                              "u_value" => 0.16 },
                            { "name" => "Roof (2)",
                              "roof_type" => 2,
                              "total_roof_area" => 10.27,
                              "u_value" => 0.21 }],
                          "sap_walls" =>
                           [{ "name" => "Walls (1)",
                              "wall_type" => 2,
                              "total_wall_area" => 120.6495,
                              "u_value" => 0.2,
                              "is_curtain_walling" => "false" }],
                          "sap_thermal_bridges" =>
                           { "thermal_bridge_code" => 4,
                             "user_defined_y_value" => 0.08,
                             "calculation_reference" => "2006 regulations" },
                          "thermal_mass_parameter" => 250 }],
                      "sap_ventilation" =>
                       { "open_fireplaces_count" => 0,
                         "open_flues_count" => 0,
                         "extract_fans_count" => 3,
                         "psv_count" => 0,
                         "flueless_gas_fires_count" => 0,
                         "pressure_test" => 1,
                         "air_permeability" => 4.85,
                         "sheltered_sides_count" => 2,
                         "ventilation_type" => 1 },
                      "sap_heating" =>
                       { "main_heating_details" =>
                          [{ "main_heating_number" => 1,
                             "main_heating_category" => 2,
                             "main_heating_fraction" => 1,
                             "main_heating_data_source" => 1,
                             "boiler_index_number" => 10_265,
                             "main_fuel_type" => 1,
                             "main_heating_control" => 2106,
                             "heat_emitter_type" => 1,
                             "main_heating_flue_type" => 2,
                             "is_flue_fan_present" => "true",
                             "is_central_heating_pump_in_heated_space" => "false",
                             "is_interlocked_system" => "true",
                             "has_delayed_start_thermostat" => "false",
                             "load_or_weather_compensation" => 0 }],
                         "secondary_heating_category" => 1,
                         "has_fixed_air_conditioning" => "false",
                         "water_heating_code" => 901,
                         "water_fuel_type" => 1,
                         "has_hot_water_cylinder" => "false",
                         "thermal_store" => 1,
                         "has_solar_panel" => "false" },
                      "sap_energy_source" =>
                       { "wind_turbines_count" => 0,
                         "wind_turbine_terrain_type" => 1,
                         "fixed_lighting_outlets_count" => 21,
                         "low_energy_fixed_lighting_outlets_count" => 12,
                         "low_energy_fixed_lighting_outlets_percentage" => 57,
                         "electricity_tariff" => 2 } }

      expect(use_case.execute(xml: sap,
                              schema_type: "SAP-Schema-NI-17.4",
                              assessment_id: "2222-3333-4444-9999-0000")).to eq(expectation)
    end
  end
end
