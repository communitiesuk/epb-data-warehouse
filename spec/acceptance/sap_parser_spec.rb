RSpec.describe "the parser and the SAP configuration" do
  let(:use_case) { UseCase::ParseXmlCertificate.new }

  context "when loading xml from SAP" do
    let(:sap) do
      Samples.xml("SAP-Schema-18.0.0")
    end

    it "parses the document in the expected format" do
      expectation = { "schema_version_original" => "18.0.0",
                      "sap_version" => 9.92,
                      "sap_data_version" => 9.92,
                      "calculation_software_name" => "Elmhurst Sap 2012 Desktop",
                      "calculation_software_version" => "4.14r16",
                      "inspection_date" => "2021-01-01",
                      "report_type" => 3,
                      "completion_date" => "2021-01-01",
                      "registration_date" => "2021-01-01",
                      "status" => "entered",
                      "language_code" => 1,
                      "tenure" => "ND",
                      "transaction_type" => 6,
                      "seller_commission_report" => "Y",
                      "property_type" => 0,
                      "scheme_assessor_id" => "EES/000000",
                      "address_line_1" => "30 Lovely Place",
                      "address_line_2" => "Nice Road",
                      "post_town" => "Town",
                      "postcode" => "LS0 0AA",
                      "uprn" => "RRN-0000-0000-0000-0000-0000",
                      "region_code" => 3,
                      "country_code" => "ENG",
                      "assessment_date" => "2021-01-01",
                      "walls" =>
                       [{ "description" => "²K",
                          "energy_efficiency_rating" => 5,
                          "environmental_efficiency_rating" => 5 }],
                      "roofs" =>
                       [{ "description" => "²K",
                          "energy_efficiency_rating" => 5,
                          "environmental_efficiency_rating" => 5 }],
                      "floors" =>
                       [{ "description" => "²K",
                          "energy_efficiency_rating" => 5,
                          "environmental_efficiency_rating" => 5 }],
                      "windows" =>
                       { "description" => "High performance glazing",
                         "energy_efficiency_rating" => 5,
                         "environmental_efficiency_rating" => 5 },
                      "main_heating" =>
                       [{ "description" => "Room heaters, electric",
                          "energy_efficiency_rating" => 1,
                          "environmental_efficiency_rating" => 2 }],
                      "main_heating_controls" =>
                       [{ "description" => "Programmer and appliance thermostats",
                          "energy_efficiency_rating" => 4,
                          "environmental_efficiency_rating" => 4 }],
                      "secondary_heating" =>
                       { "description" => "None",
                         "energy_efficiency_rating" => 0,
                         "environmental_efficiency_rating" => 0 },
                      "hot_water" =>
                       { "description" => "Electric immersion, standard tariff",
                         "energy_efficiency_rating" => 1,
                         "environmental_efficiency_rating" => 2 },
                      "lighting" =>
                       { "description" => "Low energy lighting in all fixed outlets",
                         "energy_efficiency_rating" => 5,
                         "environmental_efficiency_rating" => 5 },
                      "air_tightness" =>
                       { "description" => "³/h.m² (as tested)",
                         "energy_efficiency_rating" => 5,
                         "environmental_efficiency_rating" => 5 },
                      "has_fixed_air_conditioning" => "false",
                      "has_hot_water_cylinder" => "true",
                      "has_heated_separate_conservatory" => "false",
                      "dwelling_type" => "Mid-terrace house",
                      "total_floor_area" => 117,
                      "multiple_glazed_percentage" => 100,
                      "energy_rating_average" => 60,
                      "energy_rating_current" => 88,
                      "energy_rating_potential" => 93,
                      "environmental_impact_current" => 89,
                      "environmental_impact_potential" => 94,
                      "energy_consumption_current" => 64,
                      "energy_consumption_potential" => 39,
                      "co2_emissions_current" => 1.3,
                      "co2_emissions_potential" => 0.8,
                      "co2_emissions_current_per_floor_area" => 11,
                      "lighting_cost_current" => { "currency" => "GBP", "value" => 86 },
                      "lighting_cost_potential" => { "currency" => "GBP", "value" => 86 },
                      "heating_cost_current" => { "currency" => "GBP", "value" => 133 },
                      "heating_cost_potential" => { "currency" => "GBP", "value" => 136 },
                      "hot_water_cost_current" => { "currency" => "GBP", "value" => 361 },
                      "hot_water_cost_potential" => { "currency" => "GBP", "value" => 175 },
                      "suggested_improvements" =>
                       [{ "sequence" => 1,
                          "improvement_category" => 5,
                          "improvement_type" => "N",
                          "improvement_details" => { "improvement_number" => 19 },
                          "typical_saving" => { "currency" => "GBP", "value" => 184 },
                          "indicative_cost" => "£4,000 - £6,000",
                          "energy_performance_rating" => 93,
                          "environmental_impact_rating" => 94 }],
                      "lzc_energy_sources" => { "lzc_energy_source" => 11 },
                      "renewable_heat_incentive" =>
                       { "rhi_new_dwelling" => { "space_heating" => 413, "water_heating" => 1890 } },
                      "addendum" => { "stone_walls" => "true", "system_build" => "true" },
                      "data_type" => 2,
                      "built_form" => 4,
                      "living_area" => 38.91,
                      "orientation" => 6,
                      "conservatory_type" => 1,
                      "design_water_use" => 1,
                      "is_in_smoke_control_area" => "unknown",
                      "sap_opening_types" =>
                       [{ "name" => "Doors",
                          "data_source" => 2,
                          "type" => 1,
                          "glazing_type" => 1,
                          "u_value" => 0.75 },
                        { "name" => "Windows - W-001A",
                          "data_source" => 2,
                          "type" => 4,
                          "glazing_type" => 12,
                          "solar_transmittance" => 0.52,
                          "frame_factor" => 0.85,
                          "u_value" => 0.72 },
                        { "name" => "Windows - W-001B",
                          "data_source" => 2,
                          "type" => 4,
                          "glazing_type" => 12,
                          "solar_transmittance" => 0.52,
                          "frame_factor" => 0.84,
                          "u_value" => 0.73 },
                        { "name" => "W-003 Louvre system",
                          "data_source" => 2,
                          "type" => 4,
                          "glazing_type" => 12,
                          "solar_transmittance" => 0,
                          "frame_factor" => 0.01,
                          "u_value" => 1.02 },
                        { "name" => "Window - W-003R",
                          "data_source" => 2,
                          "type" => 4,
                          "glazing_type" => 12,
                          "solar_transmittance" => 0.53,
                          "frame_factor" => 0.78,
                          "u_value" => 0.82 },
                        { "name" => "Sliding door - EX002A",
                          "data_source" => 2,
                          "type" => 4,
                          "glazing_type" => 12,
                          "solar_transmittance" => 0.52,
                          "frame_factor" => 0.85,
                          "u_value" => 0.86 },
                        { "name" => "EX002B Louvre system",
                          "data_source" => 2,
                          "type" => 4,
                          "glazing_type" => 12,
                          "solar_transmittance" => 0,
                          "frame_factor" => 0.01,
                          "u_value" => 1 },
                        { "name" => "Window - EX002B",
                          "data_source" => 2,
                          "type" => 4,
                          "glazing_type" => 12,
                          "solar_transmittance" => 0.53,
                          "frame_factor" => 0.84,
                          "u_value" => 0.76 }],
                      "sap_building_parts" =>
                       [{ "building_part_number" => 1,
                          "identifier" => "Main Dwelling",
                          "construction_year" => 2017,
                          "overshading" => 2,
                          "sap_openings" =>
                           [{ "name" => "Opening 1",
                              "type" => "Doors",
                              "location" => "External Wall 1",
                              "orientation" => 0,
                              "width" => 2.23,
                              "height" => 1 },
                            { "name" => "Opening 2",
                              "type" => "Windows - W-001A",
                              "location" => "External Wall 1",
                              "orientation" => 6,
                              "width" => 2.3,
                              "height" => 1 },
                            { "name" => "Opening 3",
                              "type" => "W-003 Louvre system",
                              "location" => "External Wall 1",
                              "orientation" => 6,
                              "width" => 0.63,
                              "height" => 1 },
                            { "name" => "Opening 4",
                              "type" => "Window - W-003R",
                              "location" => "External Wall 1",
                              "orientation" => 6,
                              "width" => 2.38,
                              "height" => 1 },
                            { "name" => "Opening 5",
                              "type" => "Sliding door - EX002A",
                              "location" => "External Wall 1",
                              "orientation" => 6,
                              "width" => 5.37,
                              "height" => 1 },
                            { "name" => "Opening 6",
                              "type" => "Windows - W-001A",
                              "location" => "External Wall 1",
                              "orientation" => 2,
                              "width" => 2.3,
                              "height" => 1 },
                            { "name" => "Opening 7",
                              "type" => "Windows - W-001B",
                              "location" => "External Wall 1",
                              "orientation" => 2,
                              "width" => 2.06,
                              "height" => 1 },
                            { "name" => "Opening 8",
                              "type" => "Window - W-003R",
                              "location" => "External Wall 1",
                              "orientation" => 2,
                              "width" => 1.18,
                              "height" => 1 },
                            { "name" => "Opening 9",
                              "type" => "EX002B Louvre system",
                              "location" => "External Wall 1",
                              "orientation" => 2,
                              "width" => 0.95,
                              "height" => 1 },
                            { "name" => "Opening 10",
                              "type" => "Window - EX002B",
                              "location" => "External Wall 1",
                              "orientation" => 2,
                              "width" => 4.73,
                              "height" => 1 }],
                          "sap_floor_dimensions" =>
                           [{ "storey" => 0,
                              "description" => "Heat Loss Floor 1",
                              "floor_type" => 3,
                              "total_floor_area" => 38.91,
                              "storey_height" => 2.48,
                              "heat_loss_area" => 38.91,
                              "u_value" => 0.09 },
                            { "storey" => 1,
                              "floor_type" => 3,
                              "total_floor_area" => 38.91,
                              "storey_height" => 2.8,
                              "heat_loss_area" => 0,
                              "u_value" => 0 },
                            { "storey" => 2,
                              "floor_type" => 3,
                              "total_floor_area" => 38.91,
                              "storey_height" => 2.74,
                              "heat_loss_area" => 0,
                              "u_value" => 0 }],
                          "sap_roofs" =>
                           [{ "name" => "Roof 1",
                              "description" => "External Roof 1",
                              "roof_type" => 2,
                              "total_roof_area" => 38.91,
                              "u_value" => 0.1 }],
                          "sap_walls" =>
                           [{ "name" => "External Wall 1",
                              "description" => "External Wall 1",
                              "wall_type" => 2,
                              "total_wall_area" => 77.31,
                              "u_value" => 0.1,
                              "is_curtain_walling" => "false" },
                            { "name" => "Party Wall 0",
                              "wall_type" => 4,
                              "total_wall_area" => 129.44,
                              "u_value" => 0 }],
                          "sap_thermal_bridges" =>
                           { "thermal_bridge_code" => 5,
                             "thermal_bridges" =>
                              [{ "thermal_bridge_type" => "E2",
                                 "length" => 13.13,
                                 "psi_value" => 0.07,
                                 "psi_value_source" => 3 },
                               { "thermal_bridge_type" => "E3",
                                 "length" => 9.7,
                                 "psi_value" => 0.055,
                                 "psi_value_source" => 3 },
                               { "thermal_bridge_type" => "E4",
                                 "length" => 31.33,
                                 "psi_value" => 0.066,
                                 "psi_value_source" => 3 },
                               { "thermal_bridge_type" => "E20",
                                 "length" => 9.64,
                                 "psi_value" => 0.074,
                                 "psi_value_source" => 3 },
                               { "thermal_bridge_type" => "E6",
                                 "length" => 19.28,
                                 "psi_value" => 0.049,
                                 "psi_value_source" => 3 },
                               { "thermal_bridge_type" => "E15",
                                 "length" => 9.84,
                                 "psi_value" => 0.097,
                                 "psi_value_source" => 3 },
                               { "thermal_bridge_type" => "E18",
                                 "length" => 32.08,
                                 "psi_value" => 0.02,
                                 "psi_value_source" => 3 },
                               { "thermal_bridge_type" => "P2",
                                 "length" => 32.28,
                                 "psi_value" => 0,
                                 "psi_value_source" => 4 },
                               { "thermal_bridge_type" => "P7",
                                 "length" => 16.14,
                                 "psi_value" => 0.16,
                                 "psi_value_source" => 4 },
                               { "thermal_bridge_type" => "P4",
                                 "length" => 16.14,
                                 "psi_value" => 0.005,
                                 "psi_value_source" => 3 }] },
                          "thermal_mass_parameter" => 100 }],
                      "sap_ventilation" =>
                       { "open_fireplaces_count" => 0,
                         "open_flues_count" => 0,
                         "extract_fans_count" => 0,
                         "psv_count" => 0,
                         "flueless_gas_fires_count" => 0,
                         "pressure_test" => 1,
                         "air_permeability" => 0.69,
                         "sheltered_sides_count" => 3,
                         "ventilation_type" => 8,
                         "mechanical_ventilation_data_source" => 1,
                         "is_mechanical_vent_approved_installer_scheme" => "true",
                         "mechanical_vent_system_index_number" => 500_482,
                         "wet_rooms_count" => 3,
                         "mechanical_vent_duct_type" => 2,
                         "mechanical_vent_duct_insulation" => 2 },
                      "sap_heating" =>
                       { "main_heating_details" =>
                          [{ "main_heating_number" => 1,
                             "main_heating_category" => 10,
                             "main_heating_fraction" => 1,
                             "main_heating_data_source" => 3,
                             "emitter_temperature" => "NA",
                             "main_heating_code" => 691,
                             "main_fuel_type" => 39,
                             "main_heating_control" => 2603 }],
                         "secondary_heating_category" => 1,
                         "has_fixed_air_conditioning" => "false",
                         "water_heating_code" => 903,
                         "water_fuel_type" => 39,
                         "has_hot_water_cylinder" => "true",
                         "immersion_heating_type" => 1,
                         "hot_water_store_size" => 210,
                         "hot_water_store_heat_loss_source" => 2,
                         "hot_water_store_heat_loss" => 1.31,
                         "has_cylinder_thermostat" => "true",
                         "is_cylinder_in_heated_space" => "true" },
                      "sap_energy_source" =>
                       { "pv_arrays" =>
                          [{ "peak_power" => 0.75,
                             "orientation" => 6,
                             "pitch" => 2,
                             "overshading" => 1,
                             "pv_connection" => 2 }],
                         "wind_turbines_count" => 0,
                         "wind_turbine_terrain_type" => 1,
                         "fixed_lighting_outlets_count" => 20,
                         "low_energy_fixed_lighting_outlets_count" => 20,
                         "low_energy_fixed_lighting_outlets_percentage" => 100,
                         "electricity_tariff" => 1 } }
      expect(use_case.execute(xml: sap,
                              schema_type: "SAP-Schema-18.0.0",
                              assessment_id: "0000-0000-0000-0000-0000")).to eq(expectation)
    end
  end
end
